# Sidekiq - Simple, efficient background processing for Ruby
#
# Sidekiq uses threads to handle many jobs at the same time in the same process. It does not require Rails but will
# integrate tightly with Rails 3/4 to make background processing dead simple.
#
#  ____________________________________
# / This file is managed by Chef. Your \
# \ changes will be overwritten.       /
#  ------------------------------------
#         \   ^__^
#          \  (oo)\_______
#             (__)\       )\/\
#                 ||----w |
#                 ||     ||
#

description "Sidekiq"

start on filesystem
stop on runlevel [!2345]

chdir <%= @app_root.to_s.shellescape %>
env RBENV_VERSION=<%= @rbenv_version.shellescape %>

pre-start script
    test -f <%= @app_root.join("Gemfile").to_s.shellescape %> || { stop; exit 0; }
end script

script
    exec sudo -E -u <%= @original_user.shellescape %> -- rbenv exec bundle exec sidekiq -e production
end script
